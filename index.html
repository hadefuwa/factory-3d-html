<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Smart Factory Web Demo</title>
  <style>
    html, body { margin:0; padding:0; width:100%; height:100%; overflow:hidden; background:#111; color:#ddd; font-family:system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    #ui { position:fixed; top:10px; left:10px; z-index:10; background:rgba(0,0,0,0.6); padding:10px 12px; border-radius:8px; font-size:13px; }
    #ui button { margin-right:6px; }
    #legend span { display:inline-block; width:10px; height:10px; margin-right:6px; vertical-align:middle; }
    #legend div { margin-top:4px; }
  </style>
</head>
<body>
  <div id="ui">
    <div><strong>Smart Factory Demo</strong></div>
    <div style="margin-top:6px;">
      <button id="toggle">Pause</button>
      <button id="reset">Reset</button>
      <button id="release">Release 1 box</button>
      <button id="downloadLog">Download log</button>
    </div>
    <div style="margin-top:6px; font-size:12px; color:#bbb;">
      Gantry move: Arrow keys (hold Shift = faster)
    </div>
    <div id="legend" style="margin-top:8px;">
      <div><span style="background:#bfbfbf"></span>Silver</div>
      <div><span style="background:#999"></span>Grey</div>
      <div><span style="background:#d4b000"></span>Yellow</div>
      <div><span style="background:#7a4cff"></span>Purple</div>
    </div>
  </div>
  <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
      }
    }
  </script>
  <script>
    const diag = document.createElement('div');
    diag.id = 'diag';
    diag.style.position = 'fixed';
    diag.style.bottom = '10px';
    diag.style.left = '10px';
    diag.style.maxWidth = '70%';
    diag.style.color = '#fff';
    diag.style.background = 'rgba(0,0,0,0.65)';
    diag.style.padding = '8px 10px';
    diag.style.borderRadius = '8px';
    diag.style.fontSize = '12px';
    diag.style.whiteSpace = 'pre-wrap';
    diag.style.display = 'none';
    document.body.appendChild(diag);

    function logServer(msg) {
      fetch('/log', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: msg })
      }).catch(() => {});
    }

    function showDiag(msg) {
      diag.style.display = 'block';
      diag.textContent = msg;
      logServer('DIAG: ' + msg);
    }

    window.addEventListener('error', (e) => {
      showDiag('Error: ' + (e.message || 'Unknown error'));
    });
    window.addEventListener('unhandledrejection', (e) => {
      showDiag('Promise error: ' + (e.reason?.message || e.reason || 'Unknown'));
    });

    // basic fallback message if modules fail
    setTimeout(() => {
      const canvas = document.querySelector('canvas');
      if (!canvas) {
        showDiag('3D view failed to load.\nIf this keeps happening, try a different browser or send me this message.');
      }
    }, 2000);
  </script>
  <script type="module">
    import('./main.js').catch(err => {
      const msg = err && err.message ? err.message : String(err);
      const evt = new Error('Module load failed: ' + msg);
      window.dispatchEvent(new ErrorEvent('error', { message: evt.message }));
    });
  </script>
</body>
</html>
