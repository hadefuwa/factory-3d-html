<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Smart Factory Web Demo</title>
  <style>
    html, body { margin:0; padding:0; width:100%; height:100%; overflow:hidden; background:#111; color:#ddd; font-family:system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    #ui { position:fixed; top:10px; left:10px; z-index:10; background:rgba(0,0,0,0.6); padding:10px 12px; border-radius:8px; font-size:13px; }
    #ui button { margin-right:6px; }
    #legend span { display:inline-block; width:10px; height:10px; margin-right:6px; vertical-align:middle; }
    #legend div { margin-top:4px; }

    #dashboard { position:fixed; top:10px; right:10px; z-index:10; background:rgba(0,0,0,0.8); padding:15px; border-radius:8px; font-size:12px; width:280px; border:1px solid rgba(255,255,255,0.1); }
    #dashboard h3 { margin:0 0 10px 0; font-size:14px; color:#4CAF50; border-bottom:1px solid rgba(255,255,255,0.2); padding-bottom:8px; }
    .metric-row { display:flex; justify-content:space-between; margin:6px 0; padding:6px 8px; background:rgba(255,255,255,0.05); border-radius:4px; }
    .metric-label { color:#aaa; font-size:11px; }
    .metric-value { color:#fff; font-weight:600; font-size:13px; }
    .metric-value.good { color:#4CAF50; }
    .metric-value.warning { color:#FFC107; }
    .metric-value.error { color:#f44336; }
    .status-indicator { display:inline-block; width:8px; height:8px; border-radius:50%; margin-right:6px; }
    .status-indicator.running { background:#4CAF50; animation:pulse 2s infinite; }
    .status-indicator.idle { background:#FFC107; }
    .status-indicator.stopped { background:#666; }
    @keyframes pulse { 0%, 100% { opacity:1; } 50% { opacity:0.5; } }
    .section { margin-top:12px; padding-top:10px; border-top:1px solid rgba(255,255,255,0.1); }
    .chart-mini { height:40px; background:rgba(0,0,0,0.3); border-radius:4px; margin-top:8px; position:relative; overflow:hidden; }
    
    #coordinates { position:fixed; bottom:10px; left:10px; z-index:10; background:rgba(0,0,0,0.8); padding:12px 15px; border-radius:8px; font-size:14px; border:2px solid #4CAF50; font-family:monospace; }
    #coordinates .label { color:#aaa; font-size:11px; margin-bottom:4px; }
    #coordinates .values { color:#4CAF50; font-weight:bold; font-size:16px; }
  </style>
</head>
<body>
  <div id="ui">
    <div><strong>Smart Factory Demo</strong></div>
    <div style="margin-top:6px;">
      <button id="toggle">Pause</button>
      <button id="reset">Reset Cycle</button>
      <button id="release">Manual Release</button>
      <button id="downloadLog">Download log</button>
    </div>
    <div style="margin-top:6px; font-size:12px; color:#bbb;">
      Auto-release: Every 3s | Gantry: Arrow keys
    </div>
    <div id="legend" style="margin-top:8px;">
      <div><span style="background:#bfbfbf"></span>Silver</div>
      <div><span style="background:#999"></span>Grey</div>
      <div><span style="background:#d4b000"></span>Yellow</div>
      <div><span style="background:#7a4cff"></span>Purple</div>
    </div>
  </div>
  
  <div id="coordinates">
    <div class="label">MOUSE COORDINATES</div>
    <div class="values">X: <span id="mouseX">-</span> | Z: <span id="mouseZ">-</span></div>
  </div>

  <div id="dashboard">
    <h3>ðŸ“Š Live Metrics</h3>

    <div class="metric-row">
      <span class="metric-label">Throughput</span>
      <span class="metric-value" id="throughput">0 boxes/min</span>
    </div>
    <div class="metric-row">
      <span class="metric-label">Boxes Processed</span>
      <span class="metric-value" id="boxesProcessed">0</span>
    </div>
    <div class="metric-row">
      <span class="metric-label">Avg Cycle Time</span>
      <span class="metric-value" id="cycleTime">0.0s</span>
    </div>

    <div class="section">
      <div style="font-size:11px; color:#aaa; margin-bottom:8px;">Equipment Status</div>
      <div class="metric-row">
        <span class="metric-label"><span class="status-indicator running" id="gantry-status"></span>Gantry</span>
        <span class="metric-value" id="gantry-state">Idle</span>
      </div>
      <div class="metric-row">
        <span class="metric-label"><span class="status-indicator running" id="conv1-status"></span>Conveyor 1</span>
        <span class="metric-value" id="conv1-state">Running</span>
      </div>
      <div class="metric-row">
        <span class="metric-label"><span class="status-indicator running" id="conv2-status"></span>Conveyor 2</span>
        <span class="metric-value" id="conv2-state">Running</span>
      </div>
      <div class="metric-row">
        <span class="metric-label"><span class="status-indicator idle" id="robot-status"></span>Robot</span>
        <span class="metric-value" id="robot-state">Ready</span>
      </div>
    </div>

    <div class="section">
      <div style="font-size:11px; color:#aaa; margin-bottom:8px;">Queue Status</div>
      <div class="metric-row">
        <span class="metric-label">Waiting to Release</span>
        <span class="metric-value" id="queueWaiting">0</span>
      </div>
      <div class="metric-row">
        <span class="metric-label">In Transit</span>
        <span class="metric-value" id="inTransit">0</span>
      </div>
      <div class="metric-row">
        <span class="metric-label">On Pallet</span>
        <span class="metric-value good" id="onPallet">0</span>
      </div>
    </div>

    <div class="section">
      <div style="font-size:11px; color:#aaa; margin-bottom:4px;">Production Rate (last 60s)</div>
      <canvas id="throughputChart" class="chart-mini" width="250" height="40"></canvas>
    </div>
  </div>

  <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
      }
    }
  </script>
  <script>
    const diag = document.createElement('div');
    diag.id = 'diag';
    diag.style.position = 'fixed';
    diag.style.bottom = '10px';
    diag.style.left = '10px';
    diag.style.maxWidth = '70%';
    diag.style.color = '#fff';
    diag.style.background = 'rgba(0,0,0,0.65)';
    diag.style.padding = '8px 10px';
    diag.style.borderRadius = '8px';
    diag.style.fontSize = '12px';
    diag.style.whiteSpace = 'pre-wrap';
    diag.style.display = 'none';
    document.body.appendChild(diag);

    function logServer(msg) {
      fetch('/log', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: msg })
      }).catch(() => {});
    }

    function showDiag(msg) {
      diag.style.display = 'block';
      diag.textContent = msg;
      logServer('DIAG: ' + msg);
    }

    window.addEventListener('error', (e) => {
      showDiag('Error: ' + (e.message || 'Unknown error'));
    });
    window.addEventListener('unhandledrejection', (e) => {
      showDiag('Promise error: ' + (e.reason?.message || e.reason || 'Unknown'));
    });

    // basic fallback message if modules fail
    setTimeout(() => {
      const canvas = document.querySelector('canvas');
      if (!canvas) {
        showDiag('3D view failed to load.\nIf this keeps happening, try a different browser or send me this message.');
      }
    }, 2000);
  </script>
  <script type="module">
    import('./main.js').catch(err => {
      const msg = err && err.message ? err.message : String(err);
      const evt = new Error('Module load failed: ' + msg);
      window.dispatchEvent(new ErrorEvent('error', { message: evt.message }));
    });
  </script>
</body>
</html>
